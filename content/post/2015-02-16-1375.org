#+title: Hyper-VでWindows Server 2012 R2 Standardの仮想マシンを作る
#+date: 2015-02-16T12:48:19+09:00
#+draft: false
#+tags: 過去記事インポート

開発環境用にWindows Serverを立てる。この内容は下記の環境で実施した。

- Windows 8.1のクライアントHyper-Vを使う

まずは大まかにステップを確認したい。今回は下記の通りに進める。

1. Hyper-Vを有効にする
2. Hyper-Vの設定を調整する
3. Hyper-Vで仮想ネットワークを作成する
4. Hyper-Vで仮想マシンを作成する
5. 仮想マシンにOSをインストールする
6. 作成した仮想マシンの整備

## 1. Hyper-Vを有効にする

Windows 8.1にはクライアントHyper-Vに標準搭載されている。しかし、この機能はユーザーが手動で有効にしなければならない。手順は下記の通り。

1. 「コントロールパネル」を開く
2. 「プログラムと機能」を開く
3. 「Windowsの機能の有効化または無効化」を開く
4. 「Hyper-V」にチェックを入れる
5. OSを再起動する

以上でHyper-Vが有効となる。次にこのHyper-Vの設定を調整する。

## 2. Hyper-Vの設定を調整する

仮想ハードディスク、仮想マシンの保存先ディレクトリを変更する。初期設定だとCドライブになっている。これが嫌ならば下記のようにディレクトリ変更をする。問題がなければスキップする。

- 仮想ハードディスク
    - 初期値 : C:\Users\Public\Documents\Hyper-V\Virtual Hard Disks
    - 変更後 : V:\hyperv\VirtualHardDisks\
- 仮想マシン
    - 初期値 : C:\ProgramData\Microsoft\Windows\Hyper-V
    - 変更後 : V:\hyperv\

ディレクトリ変更する場合は、下記の手順で設定画面を出す。

1. Hyper-Vを起動する
2. 画面右端に位置する「Hyper-Vの設定...」をクリック
3. 「仮想ハードディスク」でディレクトリパスを指定する
4. 「仮想マシン」でディレクトリパスを指定する

次は仮想スイッチを作成する。

## 3. Hyper-Vで仮想ネットワークを作成する

MicrosoftのTechnetで[仮想ネットワークを構成する](https://technet.microsoft.com/ja-jp/library/cc816585%28v=ws.10%29.aspx)という記事で解説されている。この内容を掻い摘むと以下の通りだ。

<table>
<caption>Hyper-Vの仮想ネットワークとその種別</caption>
<tbody><tr><th>種別</th><th>内容</th></tr>
<tr><td>外部</td><td>仮想マシンと外部にある物理サーバー、それから仮想マシンとそれを管理しているOS、それに同じ物理サーバー上の仮想マシン同士で通信したい場合に選ぶ</td></tr>
<tr><td>内部</td><td>同じ物理サーバー上の仮想マシン同士、それから仮想マシンとそれを管理しているOSと通信をしたい場合に選ぶ</td></tr>
<tr><td>プライベート</td><td>同じ物理サーバー上の仮想マシン同士の通信だけで良い場合に選択する</td></tr>
</tbody></table>

状況にあったネットワークを作成する。この記事では上記の「内部」で十分であるのでこれを作る。手順は下記の通りだ。

1. 「仮想スイッチマネージャー...」をクリック
2. 内部を選ぶ。自分だけに閉じた環境なら内部で十分だと思う
3. [仮想ネットワークを構成する](https://technet.microsoft.com/ja-jp/library/cc816585%28v=ws.10%29.aspx)を参考に作る

### ネットワークのブリッジ

仮想スイッチは作成したが、このままでは作業がし辛いだろう。内部ネットワークを使っている場合は、IPアドレスが169.254.191.170といったようなものになるので、ホストの物理マシンからリモートデスクトップ接続ができない。これを回避するため、ネットワークをブリッジさせる。ブリッジさせるためにはアダプター設定の画面を開く。以下の手順を踏む。

1. コントロールパネルを開く
2. ネットワークとインターネットを開く
3. ネットワークと共有センターを開く
4. アダプター設定の変更を開く (下図1左側に位置する)
5. ブリッジさせたい仮想ネットワークを選んで、物理イーサネットを選び、右クリックでブリッジを選択する

[![Hyper-V 1](https://farm8.staticflickr.com/7312/16548757132_e09f984931_z.jpg)](https://www.flickr.com/photos/130437776@N03/16548757132 "Hyper-V 1 by hiroakit, on Flickr")

次にブリッジさせたい仮想ネットワークを選んで、物理イーサネットを選び、右クリックでブリッジを選択する。

[![Hyper-V 2](https://farm8.staticflickr.com/7309/16548757082_254941336e_z.jpg)](https://www.flickr.com/photos/130437776@N03/16548757082 "Hyper-V 2 by hiroakit, on Flickr")

少しばかり、時間がかかる。

[![Hyper-V 3](https://farm9.staticflickr.com/8650/16362388860_7f021fa70a_o.png)](https://www.flickr.com/photos/130437776@N03/16362388860 "Hyper-V 3 by hiroakit, on Flickr")

ブリッジの作成が完了すると、下図のようになる。

[![Hyper-V 4](https://farm8.staticflickr.com/7289/16548167151_16a0cc6a88_z.jpg)](https://www.flickr.com/photos/130437776@N03/16548167151 "Hyper-V 4 by hiroakit, on Flickr")

次は仮想マシンを作成する。

## 4. 仮想マシン作成

Hyper-Vの仮想マシンを作る。手順は下記の通り。

1. 新規 > 仮想マシン
2. 名前を入れる (仮想マシンは「2. Hyper-Vの設定を調整する」で指定した場所に保存される)
3. 仮想マシンの世代を選択する。Hyper-Vの常連さんが近くいればその人に合わせたほうがいいかもしれない。ここでは第2世代を選ぶ
4. メモリを指定する。後で変更可能。ここでは2048MBとした。
5. ネットワーク構成を指定する。予め「3. Hyper-Vで仮想スイッチを作成する」で作成したネットワークを選ぶ
6. 仮想ハードディスクの構成。開発環境であれば、初期設定のままで苦労することはないだろう。「次へ」を選ぶ
7. 「OSのインストールをいつするか」を決める。isoファイルがあれば、ここで指定できる
8. 最後に確認画面が出る。問題なければ「完了」ボタンを押す

次にこの仮想マシンにOSをインストールする。

## 5. 仮想マシンにOSをインストールする

OSをインストールするためには、仮想マシンを起動しなければならない。対象の仮想マシンを選び「起動」ボタンを押す。
仮想マシン作成時にOSインストールのオプションに従って動作する。

あとはWindows Server 2012のインストーラの指示に従ってインストール作業をする。
ここではWindows Server 2012 R2 Standard (GUI使用サーバー)にする。

## 6. 作成した仮想マシンの整備

個々に違うと思うが、大体はこのあたりを設定するだろう。

### リモートデスクトップ接続を有効にする

以下でリモートデスクトップ接続を有効にできる。

コントロールパネル > システムとセキュリティ でリモートアクセスの許可を選択

### ファイアウォールとポート

下記参照

- [Windows Server 2012 R2 通信ポートの開放を行う手順](http://symfoware.blog68.fc2.com/blog-entry-1231.html)

## 参考資料
- [仮想ネットワークを構成する](https://technet.microsoft.com/ja-jp/library/cc816585%28v=ws.10%29.aspx)
- [Hyper-Vで仮想マシンをネット接続するための仮想スイッチの種類 - らどこの消費生活 続き](http://ladoco.hatenablog.com/entry/2013/10/18/215134)
- [Windows 8 でHyper-V 上の複数のゲストOS を同時にインターネットに接続する方法 ＰＣプチ技能向上委員会？](http://enjoypcblog.blog32.fc2.com/blog-entry-692.html)
- [コンピュータ名で共有フォルダにアクセス出来ない！Windows名前解決の仕組み](http://blog.putise.com/%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E5%90%8D%E3%81%A7%E5%85%B1%E6%9C%89%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%87%BA%E6%9D%A5%E3%81%AA/)
